# # # # # # # # # DF: 1-st stage

FROM node:16-alpine AS builder

ENV REACT_APP_DDC_INFO_SERVICE_URL='$REACT_APP_DDC_INFO_SERVICE_URL' \
    REACT_APP_DDC_ROUTER_SERVICE_URL='$REACT_APP_DDC_ROUTER_SERVICE_URL' \
    REACT_APP_BPM_SERVICE_URL='$REACT_APP_BPM_SERVICE_URL' \
    REACT_APP_BPM_ENGINE_REST_URL='$REACT_APP_BPM_ENGINE_REST_URL' \
    REACT_APP_FILE_STORAGE_SERVICE_URL='$REACT_APP_FILE_STORAGE_SERVICE_URL' \
    REACT_APP_GATEWAY_SERVICES_URL='$REACT_APP_GATEWAY_SERVICES_URL' \
    REACT_APP_KEYCLOAK_SERVICE_URL='$REACT_APP_KEYCLOAK_SERVICE_URL' \
    REACT_APP_JSREPORT_SERVICE_URL='$REACT_APP_JSREPORT_SERVICE_URL' \
    REACT_APP_REPORT_SERVICE_URL='$REACT_APP_REPORT_SERVICE_URL' \
    REACT_APP_SYSEVN_SERVICE_URL='$REACT_APP_SYSEVN_SERVICE_URL' \
    REDIS_HOST='$REDIS_HOST' \
    REDIS_PORT='$REDIS_PORT' \
    SERVICE_PORT='$SERVICE_PORT'

RUN apk add --no-cache git

RUN git clone --branch $BRANCH https://$NEXUS_LOGIN:$NEXUS_PASS@gitlab.colvir.ru/v4web/colvir-ms/nodejs/report.git /git

WORKDIR /git
RUN git submodule init && git submodule update
RUN yarn install --development
RUN yarn run build

# # # # # # # # # DF: 2-nd stage

FROM node:16-alpine

ENV REACT_APP_DDC_INFO_SERVICE_URL='$REACT_APP_DDC_INFO_SERVICE_URL' \
    REACT_APP_DDC_ROUTER_SERVICE_URL='$REACT_APP_DDC_ROUTER_SERVICE_URL' \
    REACT_APP_BPM_SERVICE_URL='$REACT_APP_BPM_SERVICE_URL' \
    REACT_APP_BPM_ENGINE_REST_URL='$REACT_APP_BPM_ENGINE_REST_URL' \
    REACT_APP_FILE_STORAGE_SERVICE_URL='$REACT_APP_FILE_STORAGE_SERVICE_URL' \
    REACT_APP_GATEWAY_SERVICES_URL='$REACT_APP_GATEWAY_SERVICES_URL' \
    REACT_APP_KEYCLOAK_SERVICE_URL='$REACT_APP_KEYCLOAK_SERVICE_URL' \
    REACT_APP_JSREPORT_SERVICE_URL='$REACT_APP_JSREPORT_SERVICE_URL' \
    REACT_APP_REPORT_SERVICE_URL='$REACT_APP_REPORT_SERVICE_URL' \
    REACT_APP_SYSEVN_SERVICE_URL='$REACT_APP_SYSEVN_SERVICE_URL' \
    REDIS_HOST='$REDIS_HOST' \
    REDIS_PORT='$REDIS_PORT' \
    SERVICE_PORT='$SERVICE_PORT'

RUN apk add --no-cache libreoffice libreoffice-lang-ru msttcorefonts-installer fontconfig && \
    update-ms-fonts && \
    fc-cache -f

COPY --from=builder /git/package.json /usr/src/app/package.json

WORKDIR /usr/src/app
RUN yarn install --production

COPY --from=builder /git/dist /usr/src/app/dist

CMD ["node", "dist/main"]